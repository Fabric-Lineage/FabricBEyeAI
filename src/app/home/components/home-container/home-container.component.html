<section class="container" [ngClass]="{'details': !shouldShowGraph}">
    <div class="scanDetails"  *ngIf="!shouldShowGraph">
      <p class="title">Use FabricBEyeAI to generate a 3D visualization of Microsoft Fabric workspaces and their connections.</p>
      <p class="subTitle">Visualize lineage across Semantic Models, Lakehouses, Dataflows, and Reports in your Fabric tenant.</p>
      <div class="buttonContainer">
        <div class="scanButton" (click)="startScan()">
          <p>Scan tenant</p>
        </div>
        <!-- <mat-spinner class="spinner" *ngIf="isScanTenantInProgress"></mat-spinner> -->
        <div class="visButton" (click)="onAddFile()">
          <p>Show visualization</p>
        </div>
        <div class="visButton" style="margin-left: 20px;" (click)="loadDemoMode()">
           <p>Demo Mode</p>
        </div>
      </div>
    </div>
    <img class="imageGraph" src="assets/MaskGroup.png" *ngIf="!shouldShowGraph">
    
    <!-- Graph Controls Toolbar -->
    <div class="graph-controls" *ngIf="shouldShowGraph">
      <input 
        type="text" 
        class="search-input" 
        placeholder="ğŸ” Search workspaces, artifacts..."
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
      />
      
      <button class="control-btn" (click)="toggleSimulation()" [title]="simulationPaused ? 'Resume simulation' : 'Pause simulation'">
        <span>{{ simulationPaused ? 'â–¶ï¸' : 'â¸ï¸' }}</span> {{ simulationPaused ? 'Resume' : 'Pause' }}
      </button>
      
      <button class="control-btn" (click)="toggleLinkCurvature()" title="Toggle curved links">
        <span>ã€°ï¸</span> {{ linkCurvature > 0 ? 'Straight' : 'Curved' }}
      </button>
      
      <button class="control-btn" (click)="toggleFog()" title="Toggle depth fog">
        <span>ğŸŒ«ï¸</span> {{ fogEnabled ? 'No Fog' : 'Fog' }}
      </button>
      
      <button class="control-btn" (click)="zoomToFit()" title="Fit all domains to view">
        <span>ğŸ“</span> Fit
      </button>
      
      <button class="control-btn" (click)="isolateMode = !isolateMode; updateIsolationMode()" 
              [class.active]="isolateMode" title="Click domains to isolate">
        <span>ğŸ¯</span> {{ isolateMode ? 'Exit Focus' : 'Focus Mode' }}
      </button>
      
      <button class="control-btn" (click)="toggleUnassignedOnly()" 
              [class.active]="showUnassignedOnly" 
              title="Manage unassigned workspaces">
        <span>ğŸ·ï¸</span> Manage Unassigned
        <span class="badge" *ngIf="unassignedCount > 0" [class.warning]="unassignedCount > 0">
          {{ unassignedCount }}
        </span>
      </button>
      
      <button class="control-btn" (click)="toggleShowUnassignedWorkspaces()" 
              [class.active]="showUnassignedWorkspaces" 
              title="Show/hide unassigned workspaces in graph">
        <span>{{ showUnassignedWorkspaces ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}</span> 
        {{ showUnassignedWorkspaces ? 'Hide' : 'Show' }} Unassigned
      </button>
      
      <button class="control-btn" (click)="toggleFilterPanel()" title="Show filters">
        <span>ğŸ›ï¸</span> Filters
      </button>

      <button class="control-btn" (click)="toggleLegendPanel()" [class.active]="showLegendPanel" title="Show/hide legend">
        <span>ğŸ—ºï¸</span> Legend
      </button>

      <button class="control-btn" (click)="showEndorsementPanel = !showEndorsementPanel" [class.active]="showEndorsementPanel" title="Endorsement stats">
        <span>ğŸ…</span> Trust
      </button>

      <button class="control-btn" (click)="toggleSensitivityCompliance()" 
              [class.active]="showSensitivityCompliance" title="Show unlabeled artifacts">
        <span>ğŸ›¡ï¸</span> Compliance
        <span class="badge warning" *ngIf="getSensitivityStats().unlabeled > 0">
          {{ getSensitivityStats().unlabeled }}
        </span>
      </button>
      
      <button class="control-btn" (click)="exportToPNG()" title="Export as PNG">
        <span>ğŸ“·</span>
      </button>
    </div>
    
    <!-- Focus Mode Instructions -->
    <div class="focus-instructions" *ngIf="shouldShowGraph && isolateMode && !isolatedDomain">
      <span>ğŸ¯</span> Click any <strong>workspace</strong> (green badge) to isolate its domain
    </div>
    
    <div class="focus-active" *ngIf="shouldShowGraph && isolatedDomain">
      <span>âœ“</span> Showing: <strong>{{ getIsolatedDomainName() }}</strong> | Click workspace again to exit
    </div>
    
    <!-- Unassigned Mode Instructions -->
    <div class="focus-instructions" style="background: #FF9800;" *ngIf="shouldShowGraph && showUnassignedOnly && !showAssignmentPanel">
      <span>ğŸ·ï¸</span> Showing <strong>{{ unassignedCount }} unassigned workspace{{ unassignedCount !== 1 ? 's' : '' }}</strong> (orange) - Click "Unassigned" button to manage
    </div>

    <!-- Legend Panel -->
    <div class="legend-panel" *ngIf="shouldShowGraph && showLegendPanel">
      <div class="legend-header">
        <span>ğŸ—ºï¸ Legend</span>
        <button class="legend-close" (click)="showLegendPanel = false">âœ•</button>
      </div>
      <div class="legend-item">
        <span class="legend-dot" style="background: #107C10;"></span>
        <span class="legend-label">Workspace</span>
      </div>
      <div class="legend-item" *ngFor="let entry of getActiveNodeTypes()">
        <span class="legend-dot" [style.background]="entry.color"></span>
        <span class="legend-label">{{ entry.label }}</span>
        <span class="legend-count">{{ entry.count }}</span>
      </div>
    </div>

    <!-- Endorsement Stats Panel -->
    <div class="endorsement-panel" *ngIf="shouldShowGraph && showEndorsementPanel">
      <div class="endorsement-header">
        <span>ğŸ… Endorsement Coverage</span>
        <button class="legend-close" (click)="showEndorsementPanel = false">âœ•</button>
      </div>
      <div class="endorsement-bars">
        <div class="bar-row">
          <span class="bar-label">âœ… Certified</span>
          <div class="bar-track">
            <div class="bar-fill certified" [style.width.%]="getEndorsementStats().certifiedPct"></div>
          </div>
          <span class="bar-value">{{ getEndorsementStats().certified }} ({{ getEndorsementStats().certifiedPct }}%)</span>
        </div>
        <div class="bar-row">
          <span class="bar-label">â­ Promoted</span>
          <div class="bar-track">
            <div class="bar-fill promoted" [style.width.%]="getEndorsementStats().promotedPct"></div>
          </div>
          <span class="bar-value">{{ getEndorsementStats().promoted }} ({{ getEndorsementStats().promotedPct }}%)</span>
        </div>
        <div class="bar-row">
          <span class="bar-label">â€” None</span>
          <div class="bar-track">
            <div class="bar-fill none" [style.width.%]="100 - getEndorsementStats().certifiedPct - getEndorsementStats().promotedPct"></div>
          </div>
          <span class="bar-value">{{ getEndorsementStats().none }}</span>
        </div>
      </div>
      <div class="endorsement-domain-list">
        <div class="domain-row" *ngFor="let d of getEndorsementByDomain()">
          <span class="domain-name">{{ d.name }}</span>
          <span class="domain-stats">{{ d.certified }}C / {{ d.promoted }}P / {{ d.total }}</span>
        </div>
      </div>
    </div>
    
    <!-- Domain Assignment Panel -->
    <div class="assignment-panel" *ngIf="shouldShowGraph && showAssignmentPanel">
      <div class="panel-header">
        <h2>ğŸ·ï¸ Assign Workspaces to Domains</h2>
        <button class="close-btn" (click)="closeAssignmentPanel()" title="Close panel">âœ•</button>
      </div>
      
      <div class="panel-stats">
        <div class="stat">
          <span class="stat-number">{{ unassignedCount }}</span>
          <span class="stat-label">Unassigned</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ draftAssignments.size }}</span>
          <span class="stat-label">Draft Changes</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ selectedWorkspaces.size }}</span>
          <span class="stat-label">Selected</span>
        </div>
      </div>
      
      <div class="panel-search">
        <input type="text" 
               placeholder="ğŸ” Search workspaces..." 
               [(ngModel)]="assignmentSearchTerm"
               class="search-box"/>
      </div>
      
      <div class="panel-actions">
        <button class="action-btn secondary" 
                (click)="selectAllWorkspaces()"
                [disabled]="filteredUnassignedWorkspaces.length === 0">
          Select All ({{ filteredUnassignedWorkspaces.length }})
        </button>
        <button class="action-btn secondary" 
                (click)="clearSelections()"
                [disabled]="selectedWorkspaces.size === 0">
          Clear Selection
        </button>
      </div>
      
      <div class="workspace-list">
        <div class="workspace-item" 
             *ngFor="let workspace of filteredUnassignedWorkspaces"
             [class.selected]="selectedWorkspaces.has(workspace.id)"
             [class.assigned]="draftAssignments.has(workspace.id)">
          
          <div class="workspace-checkbox">
            <input type="checkbox" 
                   [checked]="selectedWorkspaces.has(workspace.id)"
                   (change)="toggleWorkspaceSelection(workspace.id)"/>
          </div>
          
          <div class="workspace-info">
            <div class="workspace-name">{{ workspace.name }}</div>
            <div class="workspace-meta">{{ getWorkspaceSummary(workspace) }}</div>
          </div>
          
          <div class="workspace-actions">
            <div class="suggestion" *ngIf="suggestDomain(workspace) as suggested">
              <span class="suggestion-label">ğŸ’¡ {{ suggested.name }}</span>
              <button class="quick-assign-btn" 
                      (click)="quickAssign(workspace.id)"
                      title="Quick assign to suggested domain">
                âš¡ Assign
              </button>
            </div>
            
            <select class="domain-select" 
                    [value]="getAssignedDomain(workspace.id)?.id || ''"
                    (change)="assignWorkspace(workspace.id, $any($event.target).value)">
              <option value="">Choose domain...</option>
              <option *ngFor="let domain of domains" 
                      [value]="domain.id"
                      [disabled]="domain.id === 'UNASSIGNED'">
                {{ domain.name }}
              </option>
            </select>
          </div>
        </div>
        
        <div class="empty-state" *ngIf="filteredUnassignedWorkspaces.length === 0">
          <div class="empty-icon">ğŸ‰</div>
          <div class="empty-text">
            <strong *ngIf="assignmentSearchTerm">No workspaces match your search</strong>
            <strong *ngIf="!assignmentSearchTerm">All workspaces are assigned!</strong>
            <p *ngIf="assignmentSearchTerm">Try a different search term</p>
            <p *ngIf="!assignmentSearchTerm">Great job organizing your tenant!</p>
          </div>
        </div>
      </div>
      
      <div class="panel-footer">
        <button class="action-btn secondary" 
                (click)="cancelAssignments()"
                [disabled]="draftAssignments.size === 0">
          Cancel Changes
        </button>
        <button class="action-btn primary" 
                (click)="saveAssignments()"
                [disabled]="draftAssignments.size === 0">
          ğŸ’¾ Save {{ draftAssignments.size }} Assignment{{ draftAssignments.size !== 1 ? 's' : '' }}
        </button>
      </div>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel" *ngIf="shouldShowGraph && showFilterPanel">
      <div class="filter-section">
        <h3>Domains</h3>
        <div class="filter-options">
          <label *ngFor="let domain of domains" class="filter-option">
            <input type="checkbox" 
                   [checked]="!hiddenDomains.has(domain.id)"
                   (change)="toggleDomain(domain.id)"/>
            <span [style.color]="getDomainColorHex(domain.id)">{{ domain.name }}</span>
          </label>
        </div>
      </div>
      
      <div class="filter-section">
        <h3>Artifact Types</h3>
        <div class="filter-options">
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showWorkspaces" (change)="applyFilters()"/>
            <span>ğŸ¢ Workspaces</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showLakehouses" (change)="applyFilters()"/>
            <span>ğŸ  Lakehouses</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showWarehouses" (change)="applyFilters()"/>
            <span>ğŸ›ï¸ Warehouses</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showReports" (change)="applyFilters()"/>
            <span>ğŸ“Š Reports</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showDatasets" (change)="applyFilters()"/>
            <span>ğŸ“¦ Datasets</span>
          </label>
        </div>
      </div>
      
      <div class="filter-section">
        <h3>Links</h3>
        <div class="filter-options">
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showCrossWorkspaceLinks" (change)="applyFilters()"/>
            <span>â†”ï¸ Cross-Workspace</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" [(ngModel)]="showContainsLinks" (change)="applyFilters()"/>
            <span>âŠ‚ Contains</span>
          </label>
          <div class="slider-control">
            <label>Link Opacity: {{linkOpacity}}%</label>
            <input type="range" min="10" max="100" [(ngModel)]="linkOpacity" (input)="updateLinkOpacity()"/>
          </div>
        </div>
      </div>
      
      <button class="reset-btn" (click)="resetFilters()">Reset All Filters</button>
    </div>

    <!-- Side Panel â€” Node Detail View -->
    <div class="side-panel" *ngIf="showSidePanel && sidePanelNode" [class.open]="showSidePanel">
      <div class="side-panel-header">
        <h3>{{ sidePanelNode.name }}</h3>
        <button class="close-btn" (click)="closeSidePanel()">âœ•</button>
      </div>
      <div class="side-panel-type">
        <span class="type-badge" [style.background]="getNodeColor(sidePanelNode.type)">
          {{ NodeType[sidePanelNode.type] }}
        </span>
      </div>
      <div class="side-panel-body">
        <!-- Workspace details -->
        <ng-container *ngIf="sidePanelNode.type === 0">
          <div class="detail-row">
            <span class="label">Domain</span>
            <span class="value">{{ sidePanelNode.metadata?.domainName || 'Unassigned' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Artifacts</span>
            <span class="value">{{ getWorkspaceArtifactCount() }}</span>
          </div>
          <div class="detail-row" *ngIf="sidePanelNode.metadata?.capacityId">
            <span class="label">Capacity</span>
            <span class="value">{{ sidePanelNode.metadata?.capacityId }}</span>
          </div>
          <div class="detail-row" *ngIf="sidePanelNode.metadata?.state">
            <span class="label">State</span>
            <span class="value">{{ sidePanelNode.metadata?.state }}</span>
          </div>
        </ng-container>

        <!-- Artifact details -->
        <ng-container *ngIf="sidePanelNode.type !== 0">
          <div class="detail-row" *ngIf="sidePanelNode.metadata?.endorsement">
            <span class="label">Endorsement</span>
            <span class="value endorsement" [class.certified]="sidePanelNode.metadata?.endorsement === 'Certified'"
                  [class.promoted]="sidePanelNode.metadata?.endorsement === 'Promoted'">
              {{ sidePanelNode.metadata?.endorsement }}
            </span>
          </div>
          <div class="detail-row" *ngIf="sidePanelNode.metadata?.certifiedBy">
            <span class="label">Certified By</span>
            <span class="value">{{ sidePanelNode.metadata?.certifiedBy }}</span>
          </div>
          <div class="detail-row" *ngIf="sidePanelNode.metadata?.sensitivityLabel">
            <span class="label">Sensitivity</span>
            <span class="value">{{ sidePanelNode.metadata?.sensitivityLabel?.labelId || 'None' }}</span>
          </div>
          <div class="detail-row" *ngIf="sidePanelNode.metadata?.description">
            <span class="label">Description</span>
            <span class="value">{{ sidePanelNode.metadata?.description }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Workspace</span>
            <span class="value">{{ sidePanelNode.workspaceId }}</span>
          </div>
        </ng-container>

        <!-- Lineage: Upstream -->
        <div class="lineage-section" *ngIf="getSidePanelUpstream().length > 0">
          <h4>â¬† Upstream ({{ getSidePanelUpstream().length }})</h4>
          <div class="lineage-item" *ngFor="let node of getSidePanelUpstream()">
            <span class="dot" [style.background]="getNodeColor(node.type)"></span>
            {{ node.name }}
          </div>
        </div>

        <!-- Lineage: Downstream -->
        <div class="lineage-section" *ngIf="getSidePanelDownstream().length > 0">
          <h4>â¬‡ Downstream ({{ getSidePanelDownstream().length }})</h4>
          <div class="lineage-item" *ngFor="let node of getSidePanelDownstream()">
            <span class="dot" [style.background]="getNodeColor(node.type)"></span>
            {{ node.name }}
          </div>
        </div>

        <!-- Impact Analysis -->
        <div class="impact-section">
          <button class="impact-btn" *ngIf="!impactAnalysisActive" (click)="runImpactAnalysis()">
            ğŸ’¥ Impact Analysis
          </button>
          <div class="impact-result" *ngIf="impactAnalysisActive">
            <span class="impact-count">{{ impactNodes.size }} affected items</span>
            <button class="impact-clear" (click)="clearImpactAnalysis()">Clear</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="3d-graph"></div>
</section>
<input hidden type="file" #filesInput (change)="onFileAdded()" multiple>
